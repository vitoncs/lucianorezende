<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Chat Jurídico</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chatContainer { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px; }
        #messages { height: 400px; overflow-y: auto; margin-bottom: 20px; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .user { background-color: #e3f2fd; align-self: flex-end; }
        .assistant { background-color: #f5f5f5; }
        #userInput { width: 70%; padding: 10px; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>Análise Jurídica Migratória</h1>
    <div id="chatContainer">
        <div id="messages"></div>
        <input type="text" id="userInput" placeholder="Digite sua pergunta...">
        <button onclick="sendMessage()">Enviar</button>
        <div id="loader" class="loader"></div>
    </div>

    <script>
        let sessionId = localStorage.getItem('sessionId') || null;

        function displayMessage(role, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `<strong>${role === 'user' ? 'Você' : 'Assistente'}:</strong> ${content}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const loader = document.getElementById('loader');
            const button = document.querySelector('button');

            if (!userInput.value.trim()) return;

            const message = userInput.value;
            userInput.value = '';
            button.disabled = true;
            loader.style.display = 'block';

            displayMessage('user', message);

            try {
                const response = await fetch('https://cors-anywhere.herokuapp.com/http://0.0.0.0:5000/ask-deepseek', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: sessionId 
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Erro na API");
                }

                displayMessage('assistant', data.response);
                
                // Atualiza o sessionId se for uma nova sessão
                if (data.session_id && data.session_id !== sessionId) {
                    sessionId = data.session_id;
                    localStorage.setItem('sessionId', sessionId);
                }

                // Opcional: Carregar histórico completo se necessário
                if (data.history) {
                    // Implemente se quiser reprocessar todo o histórico
                }

            } catch (error) {
                console.error("Erro:", error);
                displayMessage('assistant', `Erro: ${error.message}`);
            } finally {
                button.disabled = false;
                loader.style.display = 'none';
            }
        }

        // Enter key support
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
